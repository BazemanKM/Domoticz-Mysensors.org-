    commandArray = {}
     
    SAMPLE_INTERVAL = 5                 -- time in minutes when a the script logic will happen
    FAN_DELTA_TRIGGER = 5               -- rise in humidity needed for a bath that will trigger the fan
    FAN_DELTA_TRIGGER2 = 10             -- rise in humidity needed for a shower that will trigger the fan
    FAN_DELTA_TRIGGER3 = 15
    FAN_MAX_TIME = 20                   --  maximum amount of sample cycles the fan can be on,
                                        -- in case we never reach the target humidity
    TARGET_OFFSET = 2                   -- ventilator goes off if target+offset is reached
    FAN_NAME = 'Ventilator 1'           -- exact device name of the switch turning on/off the ventilator 1
    FAN_NAME2 = 'Ventilator 2'           -- exact device name of the switch turning on/off the ventilator 2
    FAN_NAME3 = 'Ventilator 3'           -- exact device name of the switch turning on/off the ventilator 3
    SENSOR_NAME = 'Badkamertemperatuur'     -- exact device name of the humidity sensor
     
    humCounter = tonumber(uservariables['humCounter'])
    humidityTmin5 = tonumber(uservariables['humidityTmin5'])                
    humidityTmin10 = tonumber(uservariables['humidityTmin10'])              
    targetFanOffHumidity = tonumber(uservariables['targetFanOffHumidity'])  
    fanMaxTimer = tonumber(uservariables['fanMaxTimer'])
     
    current = otherdevices_humidity[SENSOR_NAME]
     
    if (current == 0 or current == nil) then
        print('current is 0 or nil. Skipping this reading')
        return commandArray
    end
     
    humCounter = humCounter + 1
     
    if (humCounter >= SAMPLE_INTERVAL) then
     
        if (humidityTmin5 == 0) then
            humidityTmin5 = current
            humidityTmin10 = current
        end
     
        humCounter = 0
     
        delta = current - math.min(humidityTmin10, humidityTmin5)
     
        target = math.min(humidityTmin10, humidityTmin5) + TARGET_OFFSET
     
        humidityTmin10 = humidityTmin5
        humidityTmin5 = current
        
        if (otherdevices[FAN_NAME]=='Off' or (otherdevices[FAN_NAME]=='On' and fanFollowsProgram==0)) then
 
        if (fanFollowsProgram == 1 and otherdevices[FAN_NAME]=='Off') then
            fanFollowsProgram = 0
        end
 
        if (delta >= FAN_DELTA_TRIGGER) then
            commandArray[FAN_NAME] = 'On'
            targetFanOffHumidity = target
 
            if (fanFollowsProgram == 1) then
                print('Ventilator was already on but we start the de-humidifying program')
            end
 
            fanFollowsProgram = 1
            fanMaxTimer = FAN_MAX_TIME
 
        end
 
    else
        if (fanMaxTimer > 0) then
            fanMaxTimer = fanMaxTimer - 1
        end
 
 
        if (fanFollowsProgram == 1) then -- not manually started
 
            if (delta >= FAN_DELTA_TRIGGER) then
                fanMaxTimer = FAN_MAX_TIME
            end
 
            if (current <= targetFanOffHumidity or fanMaxTimer==0) then
                commandArray[FAN_NAME] = 'Off'
 
                msg = ''
 
                end
 
                targetFanOffHumidity = 0
                fanMaxTimer = 0
                fanFollowsProgram = 0
                humidityTmin10 = humidityTmin5
				end
            end
        end
    end
     
    end
     
    -- save the globals
    commandArray['Variable:humCounter'] = tostring(humCounter)
    commandArray['Variable:humidityTmin10'] = tostring(humidityTmin10)
    commandArray['Variable:humidityTmin5'] = tostring(humidityTmin5)
    commandArray['Variable:targetFanOffHumidity'] = tostring(targetFanOffHumidity)
    commandArray['Variable:fanMaxTimer'] = tostring(fanMaxTimer)
     
    return commandArray
